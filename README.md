# Постер в Telegram-канал (онлайн-школа 1–4 класс)

Посты по расписанию (9:00 на проверку, 13:00 / 18:00 / 19:30 в канал), опросы, черновик на одобрение Глебу. База знаний с сайта школы — в промпте и для OpenClaw. Подробный чек-лист: **CHECKLIST.md**.

## Сводка: соответствие требованиям

| Требование | Сделано |
|------------|--------|
| Не упоминать комментарии при выключенных комментариях | ✓ Промпт запрещает; `COMMENTS_ENABLED=false`; перед публикацией в канал текст прогоняется через `strip_comment_phrases()` |
| Включить комментарии в канале, бот отвечает на все | В CHECKLIST.md пошагово; включить Обсуждение → привязать группу → добавить бота → ответы через OpenClaw/скрипт в группе |
| Бот знает сайт, самокоррекция как руководитель школы | ✓ `school_knowledge.md` из сайта; в промпте и в OpenClaw systemPrompt: сверяться с базой, не выдумывать |
| Медиа в каждом посте, интересное, не повторяется | Заготовка: `MEDIA_URL` в .env; учёт использованных и авто-источник — в планах (см. CHECKLIST) |
| Черновик на проверку Глебу (9:00) | ✓ `--mode=draft` → отправка в `APPROVAL_CHAT_ID` (@Wheres_themoney_Lebowski); публикация через `publish_draft.py` после одобрения |
| Только Глеб и Екатерина дают указания; остальные — продажа | ✓ OpenClaw: systemPrompt в `openclaw-school-config.json` |
| Роль владельца школы | ✓ identity + systemPrompt + база знаний |
| Контент: уникальный, тематический, полезный, развёрнутый, ссылки на внешнее | ✓ В промпте по слотам (КТП Школа России, подборка из интернета, развёрнутый) |
| Расписание: 9:00 (с проверкой), 13:00, 18:00, 19:30 | ✓ Cron в bootstrap.sh |
| Один пост — методика КТП Школа России | ✓ Слот 13 в `SLOT_POST_TYPE` |
| Квизы/опросы 1–2 раза в день | ✓ `send_poll.py`, cron 12:00 и 17:00 МСК |
| 1 пост в день — парсинг интернета для родителей 1–4 класс | В промпте слот 18; автоматический парсинг — в планах |

## 1. Подготовка

- Создайте канал в Telegram, добавьте бота (из @BotFather) как **администратора** с правом «Публикация сообщений».
- Узнайте **username канала** (например `@mychannel`) или ID канала (например `-1001234567890`).

## 2. Локально / на VPS

```bash
cd channel-poster
python3 -m venv .venv
source .venv/bin/activate   # Windows: .venv\Scripts\activate
pip install -r requirements.txt
cp .env.example .env
```

Отредактируйте `.env`:

```env
BOT_TOKEN=ваш_токен_от_BotFather
CHANNEL=@username_вашего_канала
# Опционально, для генерации текста через ИИ:
# OPENAI_API_KEY=sk-...
```

Проверка:

```bash
python3 post.py
```

## 3. Деплой на VPS (82.152.8.99)

**Через Git (удобно для обновлений):** запушьте репозиторий, на сервере один раз сделайте `git clone <url> /opt/channel-poster`, положите в каталог `.env`. Дальше деплой: `export SSH_PASS='пароль'; ./deploy.sh git` (только подтянуть код) или `./deploy.sh git ollama` (подтянуть код и запустить установку Ollama для бота). Подробнее — **OPENCLAW_OLLAMA.md**.

**Через scp (как раньше):**

```bash
ssh root@82.152.8.99
```

На сервере:

```bash
apt update && apt install -y python3 python3-pip python3-venv
mkdir -p /opt/channel-poster
```

С вашего компьютера залейте файлы в `/opt/channel-poster/` (через scp или вручную):

```bash
scp post.py requirements.txt .env root@82.152.8.99:/opt/channel-poster/
```

На VPS снова:

```bash
cd /opt/channel-poster
python3 -m venv .venv
.venv/bin/pip install -r requirements.txt
.venv/bin/python3 post.py
```

Если пост ушёл в канал — настраиваем cron (раз в день в 9:00):

```bash
crontab -e
```

Добавьте строку (подставьте свой путь к python):

```
0 9 * * * /opt/channel-poster/.venv/bin/python3 /opt/channel-poster/post.py >> /var/log/channel-poster.log 2>&1
```

## 4. Режимы и расписание

- **9:00 МСК** — `post.py --mode=draft --slot=9`: черновик уходит только **на проверку** (в личку `APPROVAL_CHAT_ID`, например Глебу). В канал не публикуется до одобрения.
- **Одобрение:** после проверки выполнить на сервере `python3 publish_draft.py` (или настроить ответ боту «Опубликовать» через OpenClaw).
- **13:00, 18:00, 19:30 МСК** — `post.py --mode=publish --slot=N`: пост сразу в канал.
- **Опросы:** `send_poll.py` по cron 1–2 раза в день (например 12:00 и 17:00 МСК).

В `.env` задать `COMMENTS_ENABLED=false`, если у канала комментарии выключены — тогда в постах не будет призывов к комментариям.

## 4.1. Комментарии в канале

Бот **не может** включить комментарии через Bot API — это делает только владелец канала в приложении. Пошагово: **COMMENTS_INSTRUCTIONS.md** (создать группу → Настройки канала → Обсуждение → привязать группу → добавить бота в группу).

## 4.2. Первичное наполнение канала

Все посты на проверку лично Глебу (Id: 5294591231, @Wheres_themoney_Lebowski).

```bash
python3 primary_fill.py
```

Скрипт формирует **план из 7 постов** (приветствие, для кого школа, как проходят уроки, методика КТП, курсы, первое занятие бесплатно, контакты), генерирует черновики и **отправляет каждый тебе в личку**. Публикация в канал только после одобрения:

- Ответь боту цифрой **1** … **7**, чтобы опубликовать соответствующий пост (если настроен OpenClaw/обработчик), **или**
- На сервере: `python3 publish_draft.py --index 1` … `--index 7`.

Проверка без отправки в Telegram: `python3 primary_fill.py --dry-run`.

## 5. Бесплатная модель для постов (без OpenAI)

Поддерживаются **Groq** и **OpenRouter** (приоритет: Groq → OpenRouter → OpenAI). Достаточно одного ключа в `.env`:

- **Groq (бесплатно):** зарегистрироваться на [console.groq.com](https://console.groq.com), создать API‑ключ, в `.env`: `GROQ_API_KEY=gsk_...`
- **OpenRouter (есть бесплатные модели):** ключ на [openrouter.ai/settings/keys](https://openrouter.ai/settings/keys), в `.env`: `OPENROUTER_API_KEY=sk-or-v1-...`

Если ни один ключ не задан, посты идут по **шаблону** (короткий текст без нейросети).

## 6. OpenClaw на VPS (роль владельца школы)

На том же VPS установлен OpenClaw — тот же бот может отвечать в личке и в группах. Канал по-прежнему ведёт cron (post.py).

- Сервис: `systemctl status openclaw`
- Логи: `journalctl -u openclaw -f`
- Первый раз: напишите боту в личку, затем на VPS: `openclaw pairing list telegram` и `openclaw pairing approve telegram КОД`
- **Ограничение по пользователям:** только Глеб и Екатерина дают указания; остальным — информация о школе и запись. Пример конфига: `openclaw-school-config.json`.
- **Первичное наполнение через OpenClaw:** напиши боту «первичное наполнение» или «запусти наполнение канала» — он выполнит `primary_fill.py` и пришлёт тебе черновики. Ответь цифрой 1…7 — бот опубликует соответствующий пост.
- **Автономность:** бот ведёт себя как руководитель в рамках твоих пожеланий: рутину выполняет сам, не спрашивает лишний раз. Обращается к тебе только при неясности в правилах, выборе или исключении.
- **Инструкции:** главный источник правил — файл **instructions.md** в workspace OpenClaw. Бот читает его и следует ему. Ты можешь сказать: «добавь инструкцию: …», «исправь инструкцию: …», «пусть так: …» — бот обновит instructions.md и дальше будет действовать по новой версии. Можешь отвечать развёрнуто — бот зафиксирует и применит.
- **Модель для OpenClaw (бот в личке):** в конфиге по умолчанию **Groq** `groq/llama-3.1-8b-instant`. На VPS в `/opt/channel-poster/.env` добавь `GROQ_API_KEY=gsk_...` (ключ на [console.groq.com](https://console.groq.com)). **Если ключа нет и взять негде** — переключи бота на Ollama (локальная модель, ключ не нужен): см. **OPENCLAW_OLLAMA.md** и скрипт `setup_ollama_for_openclaw.sh`.
- Скопировать `school_knowledge.md` в `/root/.openclaw/workspace/` на VPS.

## 7. Безопасность

- Пароль от VPS и токен бота после настройки смените.
- Файл `.env` не коммитьте в git (уже в `.gitignore`).
